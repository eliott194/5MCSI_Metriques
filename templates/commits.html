<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Commits Metrics</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script>
      google.charts.load('current', {'packages':['corechart']});
      google.charts.setOnLoadCallback(drawChart);

      function drawChart() {
        fetch('/commits/')
          .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
          })
          .then(data => {
            var dataTable = new google.visualization.DataTable();
            dataTable.addColumn('datetime', 'Time');
            var authorsSet = new Set(data.results.map(item => item.author));
            var authors = Array.from(authorsSet);

            authors.forEach(author => {
              dataTable.addColumn('number', author);
            });

            // Initialise un objet pour stocker les comptes des commits par minute pour chaque auteur
            var countsPerMinute = {};

            // Créer une liste de toutes les minutes dans l'intervalle spécifié
            var startTime = new Date(2024, 1, 12, 14, 0, 0); // 12 février 2024, 14h
            var endTime = new Date(2024, 1, 12, 19, 0, 0); // 12 février 2024, 18h
            var time = new Date(startTime);

            while (time <= endTime) {
              var timeKey = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
              countsPerMinute[timeKey] = authors.reduce((acc, author) => ({...acc, [author]: 0}), {});
              time.setMinutes(time.getMinutes() + 1);
            }

            // Compter les commits par minute pour chaque auteur
            data.results.forEach(commit => {
              var commitTime = new Date(commit.date);
              if (commitTime >= startTime && commitTime <= endTime) {
                var timeKey = commitTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                if (countsPerMinute[timeKey]) {
                  countsPerMinute[timeKey][commit.author]++;
                }
              }
            });

            // Ajouter les données au tableau de Google Charts
            Object.keys(countsPerMinute).forEach(timeKey => {
              var timeParts = timeKey.split(':');
              var date = new Date(2024, 1, 12, parseInt(timeParts[0]), parseInt(timeParts[1]));
              var row = [date];
              authors.forEach(author => {
                row.push(countsPerMinute[timeKey][author]);
              });
              dataTable.addRow(row);
            });

            var options = {
              title: 'Commits par Minute par Auteur',
              curveType: 'function',
              legend: { position: 'bottom' },
              hAxis: {
                title: 'Temps',
                format: 'HH:mm',
              },
              vAxis: {
                title: 'Nombre de Commits',
              },
            };

            var chart = new google.visualization.LineChart(document.getElementById('chart_div'));
            chart.draw(dataTable, options);
          })
          .catch(error => {
            console.error('Fetch error:', error);
          });
      }
    </script>
</head>
<body>
    <div id="chart_div" style="width: 100%; height: 500px;"></div>
</body>
</html>
